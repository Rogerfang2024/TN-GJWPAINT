<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>活動報名</title>

  <meta name="description" content="活動報名｜請確定能參加再送出（名額有限）" />
  <meta property="og:title" content="活動報名" />
  <meta property="og:description" content="請確定能參加再送出（名額有限）" />
  <meta property="og:type" content="website" />
  <meta name="theme-color" content="#fb7185" />

  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    // ✅ 你通常只要改這三個
    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbxDlJ8o8unlRefrLvJM22lPN7E4Z-TevdkT2Lq1O9ROunLKSVKliq8qylOo_jj-FyyDzQ/exec";
    const THANKS_URL = "/thanks";
    const PIXEL_ID = ""; // 例如 "1059276802371134"；沒有就留空 ""
  </script>

  <!-- Meta Pixel（可選） -->
  <script>
    (function loadPixel(){
      if(!PIXEL_ID) return;
      localStorage.setItem("PIXEL_ID", PIXEL_ID);
      !function(f,b,e,v,n,t,s){
        if(f.fbq)return; n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n; n.push=n; n.loaded=!0; n.version='2.0';
        n.queue=[]; t=b.createElement(e); t.async=!0;
        t.src=v; s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)
      }(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');
      fbq('init', PIXEL_ID);
      fbq('track', 'PageView');
    })();
  </script>
</head>

<body class="bg-amber-50 text-slate-900">
  <div class="mx-auto max-w-3xl px-4 py-10">
    <!-- Header -->
    <div class="rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-200">
      <div class="flex items-start gap-4">
        <div class="h-10 w-10 rounded-full bg-rose-100 ring-1 ring-rose-200 grid place-items-center">
          <span class="text-rose-600 font-black">●</span>
        </div>
        <div class="flex-1">
          <div class="text-sm font-semibold text-slate-600" id="kicker">活動報名</div>
          <h1 class="mt-1 text-2xl font-bold tracking-tight" id="title">活動名稱</h1>
          <p class="mt-2 text-slate-600" id="subtitle">請確定能參加再報名（名額有限）。</p>

          <!-- ✅ 你的圖片檔名：assets/photo.png -->
          <img
            src="assets/photo.png"
            alt="活動圖片"
            class="mt-4 w-full rounded-2xl ring-1 ring-slate-200 object-cover max-h-[360px]"
            loading="lazy"
          />

          <div class="mt-4 grid gap-3 sm:grid-cols-3">
            <div class="rounded-xl bg-white ring-1 ring-amber-200 p-3">
              <div class="text-xs font-semibold text-slate-500">日期</div>
              <div class="mt-1 font-bold" id="date">-</div>
            </div>
            <div class="rounded-xl bg-white ring-1 ring-amber-200 p-3">
              <div class="text-xs font-semibold text-slate-500">時間</div>
              <div class="mt-1 font-bold" id="time">-</div>
            </div>
            <div class="rounded-xl bg-white ring-1 ring-amber-200 p-3">
              <div class="text-xs font-semibold text-slate-500">地點</div>
              <div class="mt-1 font-bold" id="place">-</div>
            </div>
          </div>

          <div class="mt-3 text-sm text-slate-600 hidden" id="addrRow">
            <span class="font-semibold">地址：</span><span id="addr"></span>
          </div>

          <ul class="mt-3 list-disc pl-5 text-sm text-slate-600 space-y-1" id="notes"></ul>
        </div>
      </div>
    </div>

    <!-- Form -->
    <div class="mt-6 rounded-2xl bg-white p-6 shadow-sm ring-1 ring-slate-200">
      <h2 class="text-lg font-bold">報名表單</h2>
      <p class="mt-2 text-sm text-slate-600">請務必填寫正確聯絡方式，以利活動通知。</p>

      <form id="signupForm" class="mt-6 space-y-5" method="post" action="">
        <!-- 隱藏欄位（由 event.json 帶入） -->
        <input type="hidden" name="活動代碼" id="event_id" />
        <input type="hidden" name="活動名稱" id="event_name" />
        <input type="hidden" name="thanks_url" id="thanks_url" />
        <input type="hidden" name="追蹤" id="tracking" />

        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <span class="text-sm font-medium">家長姓名（必填）</span>
            <input name="家長姓名" required
              class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2"
              autocomplete="name" />
          </label>

          <label class="block">
            <span class="text-sm font-medium">聯絡電話（手機）（必填）</span>
            <input name="聯絡電話（手機）" required inputmode="tel"
              class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2"
              placeholder="例如：09xxxxxxxx"
              autocomplete="tel" />
          </label>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <span class="text-sm font-medium">孩子姓名（必填）</span>
            <input name="孩子姓名" required
              class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2" />
          </label>

          <label class="block">
            <span class="text-sm font-medium">孩子年級／年齡（必填）</span>
            <select name="孩子年級／年齡" required
              class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2">
              <option value="">請選擇</option>
              <option>幼兒園</option>
              <option>國小一年級</option>
              <option>國小二年級</option>
            </select>
          </label>
        </div>

        <div class="rounded-xl bg-slate-50 p-4 ring-1 ring-slate-200">
          <div class="text-sm font-semibold">參賽組別（必填）</div>
          <div class="mt-3 grid gap-2 sm:grid-cols-2">
            <label class="flex items-center gap-2">
              <input type="radio" name="參賽組別" value="幼兒組" required />
              <span class="text-sm">幼兒組</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="參賽組別" value="國小低年級組" required />
              <span class="text-sm">國小低年級組（1–2年級）</span>
            </label>
          </div>
        </div>

        <div class="rounded-xl bg-slate-50 p-4 ring-1 ring-slate-200">
          <div class="text-sm font-semibold">是否能全程參與（9:00–12:00）（必填）</div>
          <div class="mt-3 grid gap-2 sm:grid-cols-2">
            <label class="flex items-center gap-2">
              <input type="radio" name="是否能全程參與（9:00–12:00）" value="是，我能全程參與" required />
              <span class="text-sm">是，我能全程參與</span>
            </label>
            <label class="flex items-center gap-2">
              <input type="radio" name="是否能全程參與（9:00–12:00）" value="否" required />
              <span class="text-sm text-rose-700 font-semibold">否（請勿報名）</span>
            </label>
          </div>
          <div class="mt-2 text-xs text-slate-600">這題是為了降低臨時不到，確保名額被真正需要的人使用。</div>
        </div>

        <div class="grid gap-4 md:grid-cols-2">
          <label class="block">
            <span class="text-sm font-medium">就讀學校（選填）</span>
            <input name="就讀學校（選填）"
              class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2" />
          </label>

          <div class="rounded-xl bg-slate-50 p-4 ring-1 ring-slate-200">
            <div class="text-sm font-semibold">是否為台南市民（必填）</div>
            <div class="mt-3 grid gap-2 sm:grid-cols-2">
              <label class="flex items-center gap-2">
                <input type="radio" name="是否為台南市民" value="是" required />
                <span class="text-sm">是</span>
              </label>
              <label class="flex items-center gap-2">
                <input type="radio" name="是否為台南市民" value="否" required />
                <span class="text-sm">否</span>
              </label>
            </div>
          </div>
        </div>

        <label class="block">
          <span class="text-sm font-medium">備註（選填）</span>
          <input name="備註"
            class="mt-2 w-full rounded-xl border border-slate-300 px-3 py-2" />
        </label>

        <label class="flex items-start gap-3 rounded-xl bg-slate-50 p-4 ring-1 ring-slate-200">
          <input type="checkbox" required class="mt-1 h-4 w-4" />
          <span class="text-sm text-slate-700" id="agreeText">我了解名額有限，若未接到確認電話，名額可能由候補遞補。</span>
        </label>

        <button id="submitBtn" type="submit"
          class="inline-flex w-full items-center justify-center rounded-xl bg-slate-900 px-4 py-3 text-sm font-semibold text-white hover:bg-slate-800">
          送出報名
        </button>

        <div id="warnNoFull" class="hidden rounded-xl bg-rose-50 p-4 ring-1 ring-rose-200 text-rose-800 text-sm font-semibold">
          你選了「無法全程參與」，為了名額公平，請勿送出報名。
        </div>
      </form>

      <div class="mt-4 text-xs text-slate-500" id="contact"></div>
    </div>
  </div>

  <script>
    function buildTracking() {
      const p = new URLSearchParams(location.search);
      const keep = ["utm_source","utm_medium","utm_campaign","utm_content","utm_term","fbclid"];
      const parts = [];
      keep.forEach(k=>{
        const v = (p.get(k) || "").trim();
        if(v) parts.push(`${k}=${v}`);
      });
      return parts.length ? `utm:${parts.join(";")}` : "";
    }

    function setNoFullState() {
      const no = document.querySelector('input[name="是否能全程參與（9:00–12:00）"][value="否"]');
      const warn = document.getElementById("warnNoFull");
      const btn = document.getElementById("submitBtn");
      if(no && no.checked){
        warn.classList.remove("hidden");
        btn.disabled = true;
        btn.classList.add("opacity-50","cursor-not-allowed");
      }else{
        warn.classList.add("hidden");
        btn.disabled = false;
        btn.classList.remove("opacity-50","cursor-not-allowed");
      }
    }

    async function loadEvent() {
      const res = await fetch('/event.json', { cache: 'no-store' });
      const e = await res.json();

      document.getElementById('kicker').textContent = e["小標"] || "活動報名";
      document.getElementById('title').textContent = e["活動名稱"] || '';
      document.getElementById('subtitle').textContent = e["一句話"] || '請確定能參加再報名（名額有限）。';
      document.getElementById('date').textContent = e["日期"] || '';
      document.getElementById('time').textContent = e["時間"] || '';
      document.getElementById('place').textContent = e["地點"] || '';

      const addr = e["地址"] || '';
      if (!addr) document.getElementById('addrRow').classList.add('hidden');
      document.getElementById('addr').textContent = addr;

      const notes = document.getElementById('notes');
      notes.innerHTML = '';
      (e["注意事項"] || []).forEach(t => {
        const li = document.createElement('li');
        li.textContent = t;
        notes.appendChild(li);
      });

      const phone = e["聯絡電話"] || '';
      document.getElementById('contact').textContent = phone ? `聯絡電話：${phone}` : '';

      document.getElementById('event_id').value = e["活動代碼"] || '';
      document.getElementById('event_name').value = e["活動名稱"] || '';
      document.getElementById('thanks_url').value = location.origin + THANKS_URL;

      // ✅ 追蹤參數：不顯示在表單、只送到後端（寫進備註時由 Code.gs 控制）
      document.getElementById('tracking').value = buildTracking();

      document.getElementById('agreeText').textContent =
        e["規則同意文"] || '我了解名額有限，若未接到確認電話，名額可能由候補遞補。';

      const form = document.getElementById('signupForm');
      form.action = GAS_WEBAPP_URL;
    }

    document.addEventListener("change", (ev)=>{
      if(ev.target && ev.target.name === "是否能全程參與（9:00–12:00）") setNoFullState();
    });

    document.getElementById("signupForm").addEventListener("submit", ()=>{
      const btn = document.getElementById("submitBtn");
      btn.disabled = true;
      btn.textContent = "送出中…";
    });

    loadEvent().then(setNoFullState).catch(console.error);
  </script>
</body>
</html>
